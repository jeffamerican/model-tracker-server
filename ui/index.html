<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Pricing Service</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .search-bar {
            flex: 1;
            min-width: 300px;
        }
        .search-bar input {
            padding: 10px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }
        .dropdown-container {
            position: relative;
            display: inline-block;
        }
        .dropdown-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
        }
        .dropdown-btn:hover {
            background: #f0f0f0;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 6px;
            z-index: 1001;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .api-toggle {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-item:hover {
            background: #f5f5f5;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item input[type="checkbox"] {
            margin: 0;
        }
        .dropdown-header {
            padding: 8px 12px;
            background: #f8f9fa;
            font-weight: 600;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
        }
        .service-count {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .fixed-header {
            flex-shrink: 0;
            background: #f5f5f5;
            padding: 20px 20px 0 20px;
            z-index: 100;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .scrollable-content {
            flex: 1;
            overflow: auto;
            padding: 0 20px 20px 20px;
        }
        
        .table-wrapper {
            position: relative;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-scrollbar-top {
            overflow-x: auto;
            overflow-y: hidden;
            height: 8px;
            margin-bottom: 4px;
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }
        
        .table-scrollbar-top::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-scrollbar-top::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .table-scrollbar-top::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        
        .table-scrollbar-top::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
        
        .table-container {
            position: relative;
            max-width: 100%;
            overflow: hidden;
        }
        
        .table-header {
            background: #fafafa;
            border-bottom: 2px solid #ddd;
        }
        
        .table-body-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 400px);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .table-body-container::-webkit-scrollbar {
            display: none;
        }
        table {
            min-width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            white-space: nowrap;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
            color: #333;
            vertical-align: top;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background: #fafafa;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            position: relative;
        }
        th:hover {
            background: #f0f0f0;
        }
        .column-resize-handle {
            position: absolute;
            right: -3px;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
        }
        .column-resize-handle:hover {
            background: #1976d2;
        }
        .column-resize-handle.active {
            background: #1976d2;
        }
        .column-resize-handle::after {
            content: '';
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 20px;
            background: #ccc;
            border-radius: 1px;
        }
        .column-resize-handle:hover::after {
            background: #1976d2;
        }
        .column-drag-handle {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: move;
            background: transparent;
            z-index: 10;
        }
        .column-drag-handle:hover {
            background: #ff9800;
        }
        .column-drag-handle.active {
            background: #ff9800;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .no-schema {
            color: #d32f2f !important;
            background-color: #ffebee !important;
        }
        .no-schema:hover {
            background-color: #ffcdd2 !important;
        }
        .no-schema td {
            color: #d32f2f !important;
        }
        .modality-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        .modality-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }
        .api-identifier {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-top: 4px;
            display: inline-block;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        .error {
            color: #d32f2f;
            text-align: center;
            padding: 20px;
        }
        .refresh-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .refresh-btn:hover {
            background: #1565c0;
        }
        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #1976d2;
        }
        .stat-card:active {
            transform: translateY(0);
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .source-link {
            color: #1976d2;
            text-decoration: none;
            font-size: 12px;
        }
        .source-link:hover {
            text-decoration: underline;
        }
        .no-modalities {
            color: #999;
            font-style: italic;
            font-size: 12px;
        }
        .service-type {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        .service-list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .service-list-item:last-child {
            border-bottom: none;
        }
        .service-list-item:hover {
            background-color: #f8f9fa;
        }
        .service-name {
            font-weight: 600;
            color: #1976d2;
            font-size: 14px;
        }
        .service-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .service-provider, .service-modalities, .service-count, .service-types, .service-providers {
            font-size: 12px;
            color: #666;
        }
        .service-count {
            font-weight: 600;
            color: #1976d2;
        }
        .new-badge {
            background: #ff9800;
            color: white;
            padding: 2px 4px;
            margin-left: 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .new-model {
            background: #fff8e1;
        }
        body.dark-mode .new-model {
            background: rgba(255, 152, 0, 0.2);
        }
        .toggle-btn {
            background: white;
            color: #1976d2;
            border: 1px solid #1976d2;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .toggle-btn:hover {
            background: #e3f2fd;
        }
        .column-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .column-control-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .column-control-btn:hover {
            background: #f0f0f0;
        }
        .column-control-btn.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        body.dark-mode .fixed-header {
            background: #121212;
            border-bottom-color: #333;
        }
        body.dark-mode .table-wrapper {
            background: #1e1e1e;
        }
        body.dark-mode .table-scrollbar-top {
            scrollbar-color: #555 transparent;
        }
        body.dark-mode .table-scrollbar-top::-webkit-scrollbar-thumb {
            background: #555;
        }
        body.dark-mode .table-scrollbar-top::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        body.dark-mode .table-container {
            background: #1e1e1e;
        }
        body.dark-mode .table-header {
            background: #2c2c2c;
            border-bottom-color: #555;
        }
        body.dark-mode table {
            background: #1e1e1e;
            color: #e0e0e0;
        }
        body.dark-mode th {
            background: #2c2c2c;
            color: #e0e0e0;
        }
        body.dark-mode th:hover {
            background: #333;
        }
        body.dark-mode tr:hover {
            background-color: #333;
        }
        body.dark-mode .stat-card {
            background: #1e1e1e;
        }
        body.dark-mode .source-link {
            color: #90caf9;
        }
        body.dark-mode .modality-badge {
            background: #263238;
            color: #90caf9;
        }
        body.dark-mode .api-identifier {
            background: #4a148c;
            color: #e1bee7;
        }
        body.dark-mode .toggle-btn {
            background: #333;
            color: #fff;
            border-color: #333;
        }
        body.dark-mode .toggle-btn:hover {
            background: #444;
        }
        body.dark-mode .dropdown-btn {
            background: #333;
            color: #fff;
            border-color: #555;
        }
        body.dark-mode .dropdown-content {
            background: #333;
            border-color: #555;
        }
        body.dark-mode .dropdown-item {
            color: #fff;
            border-bottom-color: #555;
        }
        body.dark-mode .dropdown-item:hover {
            background: #444;
        }
        body.dark-mode .dropdown-header {
            background: #2c2c2c;
            color: #fff;
            border-bottom-color: #555;
        }
        body.dark-mode .column-controls {
            background: #2c2c2c;
        }
        body.dark-mode .column-control-btn {
            background: #333;
            color: #fff;
            border-color: #555;
        }
        body.dark-mode .column-control-btn:hover {
            background: #444;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            max-height: 80%;
            overflow: auto;
        }
        .modal-close {
            float: right;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }
        body.dark-mode .modal-content {
            background: #1e1e1e;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span id="modalClose" class="modal-close">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    <div id="serviceListModal" class="modal">
        <div class="modal-content">
            <span id="serviceListModalClose" class="modal-close">&times;</span>
            <h2 id="serviceListTitle"></h2>
            <div id="serviceListBody"></div>
        </div>
    </div>
    <div class="main-container">
        <div class="fixed-header">
            <div class="header">
                <h1>AI Model Pricing Service</h1>
                <p>Real-time pricing information for AI models, APIs, and server rentals</p>
                <button class="refresh-btn" onclick="loadPricing()">Refresh Data</button>
            </div>

            <div class="stats" id="stats">
                <!-- Stats will be populated here -->
            </div>

            <div class="controls">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search models, pricing, or modalities..." oninput="filterTable()">
                </div>
                <div class="dropdown-container">
                    <button class="dropdown-btn" onclick="toggleDropdown('modalities')">
                        Modalities <span class="service-count" id="modalityCount">0</span> ▼
                    </button>
                    <div class="dropdown-content" id="modalitiesDropdown">
                        <!-- Modality toggles will be populated here -->
                    </div>
                </div>
                <div class="dropdown-container">
                    <button class="dropdown-btn" onclick="toggleDropdown('columns')">
                        Columns <span class="service-count" id="columnCount">0</span> ▼
                    </button>
                    <div class="dropdown-content" id="columnsDropdown">
                        <!-- Column toggles will be populated here -->
                    </div>
                </div>
                <div class="dropdown-container">
                    <button class="dropdown-btn" onclick="toggleDropdown('providers')">
                        Providers <span class="service-count" id="providerCount">0</span> ▼
                    </button>
                    <div class="dropdown-content" id="providersDropdown">
                        <!-- Provider list will be populated here -->
                    </div>
                </div>
                <label class="api-toggle"><input type="checkbox" id="apiFilter" onchange="filterTable()"> API endpoints only</label>
                <button id="themeToggle" class="toggle-btn">Toggle Dark Mode</button>
            </div>

            <div class="column-controls" id="columnControls">
                <span style="font-weight: 600; font-size: 12px;">Column Controls:</span>
                <button class="column-control-btn" onclick="resetColumnWidths()">Reset Widths</button>
                <button class="column-control-btn" onclick="resetColumnOrder()">Reset Order</button>
                <button class="column-control-btn" onclick="toggleColumnResize()" id="resizeToggle">Enable Resize</button>
                <button class="column-control-btn" onclick="toggleColumnDrag()" id="dragToggle">Enable Drag</button>
            </div>
        </div>

        <div class="scrollable-content">
            <div id="content">
                <div class="loading">Loading pricing data...</div>
            </div>
        </div>
    </div>

    <script>
        let tableData = [];
        let displayData = [];
        let allModalities = new Set();
        let selectedModalities = new Set();
        let allColumns = [];
        let visibleColumns = new Set();
        let allProviders = new Set();
        let columnWidths = {};
        let columnOrder = [];
        let resizeMode = false;
        let dragMode = false;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let draggedColumn = null;

        // Theme initialization
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        document.getElementById('themeToggle').addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
        });

        // Function to determine if an entry is a server/GPU rental
        function isServerRental(modelId, details) {
            const serverKeywords = ['H100', 'H200', 'A100', 'B200', 'GPU', 'VRAM'];
            const hasServerKeyword = serverKeywords.some(keyword => 
                modelId.includes(keyword) || 
                Object.keys(details).some(key => key.includes(keyword))
            );
            const hasPricingPerHour = Object.keys(details).some(key => 
                key.toLowerCase().includes('hour') || key.toLowerCase().includes('second')
            );
            return hasServerKeyword || hasPricingPerHour;
        }

        // Function to determine if an entry is an API endpoint
        function isApiEndpoint(modelId, details, modalities) {
            // Check if it has modalities (text, image, etc.)
            if (modalities && modalities.length > 0) {
                return true;
            }
            
            // Check for API-specific keywords in model ID
            const apiKeywords = ['gpt', 'claude', 'gemini', 'llama', 'mistral', 'cohere', 'anthropic', 'openai', 'text', 'image', 'vision', 'audio', 'speech'];
            const hasApiKeyword = apiKeywords.some(keyword => 
                modelId.toLowerCase().includes(keyword)
            );
            
            // Check for token-based pricing (typical for APIs)
            const hasTokenPricing = Object.keys(details).some(key => 
                key.toLowerCase().includes('token') || key.toLowerCase().includes('input') || key.toLowerCase().includes('output')
            );
            
            // Check for per-request pricing (typical for APIs)
            const hasPerRequestPricing = Object.keys(details).some(key => 
                key.toLowerCase().includes('request') || key.toLowerCase().includes('call') || key.toLowerCase().includes('query')
            );
            
            return hasApiKeyword || hasTokenPricing || hasPerRequestPricing;
        }

        // Function to get service type label
        function getServiceType(modelId, details, modalities) {
            if (isServerRental(modelId, details)) {
                return 'server_rental';
            } else if (isApiEndpoint(modelId, details, modalities)) {
                return 'api_endpoint';
            } else {
                return 'other_service';
            }
        }

        async function loadPricing() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Loading pricing data...</div>';

            try {
                const response = await fetch('/api/pricing');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (Object.keys(data).length === 0) {
                    content.innerHTML = '<div class="error">No pricing data available</div>';
                    return;
                }

                // Process data and collect modalities
                tableData = Object.entries(data).map(([modelId, modelData]) => {
                    let modalities = modelData.modalities || [];

                    // Add 'server' modality for server/GPU rentals
                    if (isServerRental(modelId, modelData.raw || {})) {
                        if (!modalities.includes('server')) {
                            modalities = [...modalities, 'server'];
                        }
                    }

                    modalities.forEach(modality => allModalities.add(modality));

                    // Collect API identifiers
                    if (modelData.api_identifier) {
                        allProviders.add(modelData.api_identifier);
                    }

                    const details = {
                        ...(modelData.raw || {}),
                    };
                    if (modelData.generation_latency) {
                        details.generation_latency = modelData.generation_latency;
                    }
                    if (modelData.description) {
                        details.description = modelData.description;
                    }

                    return {
                        modelId,
                        details,
                        source: modelData.source || '',
                        modalities: modalities,
                        serviceType: modelData.service_type || getServiceType(modelId, modelData.raw || {}, modalities),
                        apiIdentifier: modelData.api_identifier || 'unknown',
                        apiSchema: modelData.api_schema || null,
                        lastUpdated: modelData.last_updated || null,
                    };
                });

                allColumns = Array.from(new Set(tableData.flatMap(item => Object.keys(item.details))));
                const savedCols = JSON.parse(localStorage.getItem('visibleColumns') || 'null');
                if (savedCols && savedCols.length > 0) {
                    visibleColumns = new Set(savedCols.filter(col => allColumns.includes(col)));
                } else {
                    visibleColumns = new Set(allColumns);
                }

                // Load saved column settings
                columnWidths = JSON.parse(localStorage.getItem('columnWidths') || '{}');
                columnOrder = JSON.parse(localStorage.getItem('columnOrder') || '[]');
                
                // Initialize column order if not set
                if (columnOrder.length === 0) {
                    columnOrder = [...allColumns];
                }

                renderModalityControls();
                renderColumnControls(allColumns);
                renderProviderList();
                updateStats();
                renderTable(tableData);

            } catch (error) {
                content.innerHTML = `<div class="error">Error loading pricing data: ${error.message}</div>`;
            }
        }

        function updateStats() {
            const statsDiv = document.getElementById('stats');
            const totalModels = tableData.length;
            const totalModalities = allModalities.size;
            const apiEndpoints = tableData.filter(item => item.serviceType === 'api_endpoint').length;
            const serverRentals = tableData.filter(item => item.serviceType === 'server_rental').length;
            const totalProviders = allProviders.size;

            statsDiv.innerHTML = `
                <div class="stat-card" onclick="showServiceList('all', 'All Services')">
                    <div class="stat-number">${totalModels}</div>
                    <div class="stat-label">Total Services</div>
                </div>
                <div class="stat-card" onclick="showServiceList('api_endpoint', 'API Endpoints')">
                    <div class="stat-number">${apiEndpoints}</div>
                    <div class="stat-label">API Endpoints</div>
                </div>
                <div class="stat-card" onclick="showServiceList('server_rental', 'Server Rentals')">
                    <div class="stat-number">${serverRentals}</div>
                    <div class="stat-label">Server Rentals</div>
                </div>
                <div class="stat-card" onclick="showProviderList()">
                    <div class="stat-number">${totalProviders}</div>
                    <div class="stat-label">Providers</div>
                </div>
                <div class="stat-card" onclick="showModalityList()">
                    <div class="stat-number">${totalModalities}</div>
                    <div class="stat-label">Modalities</div>
                </div>
            `;
        }

        function renderModalityControls() {
            const container = document.getElementById('modalitiesDropdown');
            container.innerHTML = '<div class="dropdown-header">Filter by Modalities</div>';
            
            // Add "All" option
            const allItem = document.createElement('div');
            allItem.className = 'dropdown-item';
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.checked = selectedModalities.size === 0;
            allCheckbox.onchange = () => {
                selectedModalities.clear();
                document.querySelectorAll('#modalitiesDropdown input[type="checkbox"]').forEach(cb => {
                    if (cb !== allCheckbox) cb.checked = false;
                });
                updateModalityCount();
                filterTable();
            };
            allItem.appendChild(allCheckbox);
            allItem.appendChild(document.createTextNode('All Modalities'));
            container.appendChild(allItem);
            
            // Add modality options
            Array.from(allModalities).sort().forEach(modality => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedModalities.has(modality);
                checkbox.onchange = () => {
                    if (checkbox.checked) {
                        selectedModalities.add(modality);
                        allCheckbox.checked = false;
                    } else {
                        selectedModalities.delete(modality);
                        if (selectedModalities.size === 0) {
                            allCheckbox.checked = true;
                        }
                    }
                    updateModalityCount();
                    filterTable();
                };
                
                item.appendChild(checkbox);
                item.appendChild(document.createTextNode(modality));
                container.appendChild(item);
            });
            
            updateModalityCount();
        }

        function renderColumnControls(keys) {
            const container = document.getElementById('columnsDropdown');
            container.innerHTML = '<div class="dropdown-header">Toggle Columns</div>';
            
            keys.forEach(key => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = visibleColumns.has(key);
                checkbox.onchange = () => {
                    if (checkbox.checked) {
                        visibleColumns.add(key);
                    } else {
                        visibleColumns.delete(key);
                    }
                    localStorage.setItem('visibleColumns', JSON.stringify(Array.from(visibleColumns)));
                    updateColumnCount();
                    renderTable(displayData);
                };
                
                item.appendChild(checkbox);
                item.appendChild(document.createTextNode(key));
                container.appendChild(item);
            });
            
            updateColumnCount();
        }

        function renderProviderList() {
            const container = document.getElementById('providersDropdown');
            container.innerHTML = '<div class="dropdown-header">Data Providers</div>';
            
            const providerStats = {};
            tableData.forEach(item => {
                const provider = item.apiIdentifier;
                if (!providerStats[provider]) {
                    providerStats[provider] = 0;
                }
                providerStats[provider]++;
            });
            
            Object.entries(providerStats).sort((a, b) => b[1] - a[1]).forEach(([provider, count]) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <span>${provider}</span>
                    <span class="service-count">${count}</span>
                `;
                container.appendChild(item);
            });
            
            document.getElementById('providerCount').textContent = allProviders.size;
        }

        function updateModalityCount() {
            const count = selectedModalities.size === 0 ? allModalities.size : selectedModalities.size;
            document.getElementById('modalityCount').textContent = count;
        }

        function updateColumnCount() {
            document.getElementById('columnCount').textContent = visibleColumns.size;
        }

        function toggleDropdown(type) {
            const dropdown = document.getElementById(type + 'Dropdown');
            const allDropdowns = document.querySelectorAll('.dropdown-content');
            
            // Close other dropdowns
            allDropdowns.forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                }
            });
            
            // For modalities dropdown, only toggle if it's not already open
            if (type === 'modalities') {
                if (!dropdown.classList.contains('show')) {
                    dropdown.classList.add('show');
                }
            } else {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            // Don't close if clicking on dropdown content or checkboxes
            if (event.target.closest('.dropdown-content') || event.target.type === 'checkbox') {
                return;
            }
            
            // Don't close if clicking on dropdown button
            if (event.target.matches('.dropdown-btn')) {
                return;
            }
            
            const dropdowns = document.querySelectorAll('.dropdown-content');
            dropdowns.forEach(dropdown => {
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            });
        }

        function renderTable(data) {
            displayData = data;
            const content = document.getElementById('content');
            const columns = Array.from(visibleColumns).sort((a, b) => {
                const aIndex = columnOrder.indexOf(a);
                const bIndex = columnOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return 0;
                if (aIndex === -1) return 1;
                if (bIndex === -1) return 0;
                return aIndex - bIndex;
            });

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // Model column
            const modelHeader = document.createElement('th');
            modelHeader.textContent = 'Model/Service';
            modelHeader.onclick = () => sortTable('modelId');
            const modelWidth = columnWidths['modelId'] || 'auto';
            modelHeader.style.width = modelWidth;
            if (resizeMode) {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'column-resize-handle';
                resizeHandle.title = 'Drag to resize column';
                resizeHandle.onmousedown = (e) => startResize(e, 'modelId');
                modelHeader.appendChild(resizeHandle);
            }
            if (dragMode) {
                const dragHandle = document.createElement('div');
                dragHandle.className = 'column-drag-handle';
                dragHandle.onmousedown = (e) => startDrag(e, 'modelId');
                modelHeader.appendChild(dragHandle);
            }
            headerRow.appendChild(modelHeader);

            // Modalities column
            const modalitiesHeader = document.createElement('th');
            modalitiesHeader.textContent = 'Modalities';
            modalitiesHeader.style.minWidth = '150px';
            const modalitiesWidth = columnWidths['modalities'] || 'auto';
            modalitiesHeader.style.width = modalitiesWidth;
            if (resizeMode) {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'column-resize-handle';
                resizeHandle.title = 'Drag to resize column';
                resizeHandle.onmousedown = (e) => startResize(e, 'modalities');
                modalitiesHeader.appendChild(resizeHandle);
            }
            if (dragMode) {
                const dragHandle = document.createElement('div');
                dragHandle.className = 'column-drag-handle';
                dragHandle.onmousedown = (e) => startDrag(e, 'modalities');
                modalitiesHeader.appendChild(dragHandle);
            }
            headerRow.appendChild(modalitiesHeader);

            // Pricing columns
            columns.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                th.onclick = () => sortTable(key);
                const colWidth = columnWidths[key] || 'auto';
                th.style.width = colWidth;
                if (resizeMode) {
                    const resizeHandle = document.createElement('div');
                    resizeHandle.className = 'column-resize-handle';
                    resizeHandle.title = 'Drag to resize column';
                    resizeHandle.onmousedown = (e) => startResize(e, key);
                    th.appendChild(resizeHandle);
                }
                if (dragMode) {
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'column-drag-handle';
                    dragHandle.onmousedown = (e) => startDrag(e, key);
                    th.appendChild(dragHandle);
                }
                headerRow.appendChild(th);
            });

            // Source column
            const sourceHeader = document.createElement('th');
            sourceHeader.textContent = 'Source';
            const sourceWidth = columnWidths['source'] || 'auto';
            sourceHeader.style.width = sourceWidth;
            if (resizeMode) {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'column-resize-handle';
                resizeHandle.title = 'Drag to resize column';
                resizeHandle.onmousedown = (e) => startResize(e, 'source');
                sourceHeader.appendChild(resizeHandle);
            }
            if (dragMode) {
                const dragHandle = document.createElement('div');
                dragHandle.className = 'column-drag-handle';
                dragHandle.onmousedown = (e) => startDrag(e, 'source');
                sourceHeader.appendChild(dragHandle);
            }
            headerRow.appendChild(sourceHeader);

            // Create the table wrapper structure
            const wrapper = document.createElement('div');
            wrapper.className = 'table-wrapper';
            
            // Create top scrollbar with spacer
            const topScrollbar = document.createElement('div');
            topScrollbar.className = 'table-scrollbar-top';
            
            // Create a spacer div that matches the table width
            const spacer = document.createElement('div');
            spacer.style.width = '1px';
            spacer.style.height = '1px';
            spacer.style.visibility = 'hidden';
            topScrollbar.appendChild(spacer);
            
            // Create table container
            const container = document.createElement('div');
            container.className = 'table-container';
            
            // Create body container with scrollable content
            const bodyContainer = document.createElement('div');
            bodyContainer.className = 'table-body-container';
            
            // Create the main table with header and body
            const mainTable = document.createElement('table');
            
            // Add header to main table
            const mainThead = document.createElement('thead');
            mainThead.appendChild(headerRow);
            mainTable.appendChild(mainThead);
            
            const tbody = document.createElement('tbody');

            const buildRow = (item) => {
                const tr = document.createElement('tr');

                const isNew = item.lastUpdated && (Date.now() - new Date(item.lastUpdated).getTime() < 7 * 24 * 60 * 60 * 1000);
                if (isNew) {
                    tr.classList.add('new-model');
                }

                const schemaValue = item.apiSchema;
                const hasSchema = (() => {
                    if (!schemaValue) {
                        return false;
                    }
                    if (typeof schemaValue === 'string') {
                        return schemaValue.trim().length > 0;
                    }
                    if (typeof schemaValue === 'object') {
                        return Object.keys(schemaValue).length > 0;
                    }
                    return false;
                })();
                if (!hasSchema) {
                    tr.classList.add('no-schema');
                }

                const modelCell = document.createElement('td');
                modelCell.style.width = modelWidth;
                modelCell.innerHTML = `
                    <div>${item.modelId}${isNew ? '<span class="new-badge">NEW</span>' : ''}</div>
                    <div class="service-type">${item.serviceType}</div>
                    <div class="api-identifier">${item.apiIdentifier}</div>
                `;
                tr.appendChild(modelCell);

                const modalitiesCell = document.createElement('td');
                modalitiesCell.style.width = modalitiesWidth;
                if (item.modalities && item.modalities.length > 0) {
                    const badgesDiv = document.createElement('div');
                    badgesDiv.className = 'modality-badges';
                    item.modalities.forEach(modality => {
                        const badge = document.createElement('span');
                        badge.className = 'modality-badge';
                        badge.textContent = modality;
                        badgesDiv.appendChild(badge);
                    });
                    modalitiesCell.appendChild(badgesDiv);
                } else {
                    modalitiesCell.innerHTML = '<span class="no-modalities">No modalities specified</span>';
                }
                tr.appendChild(modalitiesCell);

                columns.forEach(key => {
                    const td = document.createElement('td');
                    const colWidth = columnWidths[key] || 'auto';
                    td.style.width = colWidth;
                    const value = item.details[key];
                    if (typeof value === 'object' && value !== null) {
                        td.innerHTML = formatNestedValue(value);
                    } else {
                        td.textContent = value ?? '';
                    }
                    tr.appendChild(td);
                });

                const sourceCell = document.createElement('td');
                sourceCell.style.width = sourceWidth;
                if (item.source) {
                    sourceCell.innerHTML = `<a href="${item.source}" target="_blank" class="source-link">View</a>`;
                }
                tr.appendChild(sourceCell);

                tr.addEventListener('click', (e) => {
                    if (e.target.tagName.toLowerCase() !== 'a') {
                        showDetails(item);
                    }
                });

                return tr;
            };

            const chunkSize = 40;
            let rowIndex = 0;

            const appendChunk = () => {
                if (rowIndex >= data.length) {
                    requestAnimationFrame(() => {
                        const tableWidth = mainTable.scrollWidth;
                        spacer.style.width = tableWidth + 'px';
                    });
                    return;
                }

                const fragment = document.createDocumentFragment();
                const end = Math.min(rowIndex + chunkSize, data.length);
                for (; rowIndex < end; rowIndex += 1) {
                    fragment.appendChild(buildRow(data[rowIndex]));
                }
                tbody.appendChild(fragment);

                requestAnimationFrame(() => {
                    spacer.style.width = mainTable.scrollWidth + 'px';
                });

                requestAnimationFrame(appendChunk);
            };

            if (data.length === 0) {
                spacer.style.width = '100%';
            } else {
                requestAnimationFrame(appendChunk);
            }

            mainTable.appendChild(tbody);
            bodyContainer.appendChild(mainTable);
            
            // Synchronize scrolling between top scrollbar and body container
            topScrollbar.addEventListener('scroll', () => {
                bodyContainer.scrollLeft = topScrollbar.scrollLeft;
            });
            
            bodyContainer.addEventListener('scroll', () => {
                topScrollbar.scrollLeft = bodyContainer.scrollLeft;
            });
            
            // Add elements to container
            container.appendChild(bodyContainer);
            
            // Add elements to wrapper
            wrapper.appendChild(topScrollbar);
            wrapper.appendChild(container);

            content.replaceChildren(wrapper);
        }

        function formatNestedValue(obj) {
            if (typeof obj !== 'object' || obj === null) {
                return obj || '';
            }
            
            const items = Object.entries(obj).map(([key, value]) => {
                return `<strong>${key}:</strong> ${value}`;
            });
            
            return items.join('<br>');
        }

        let currentSort = { key: '', asc: true };

        function sortTable(key) {
            if (currentSort.key === key) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort = { key, asc: true };
            }

            const sorted = [...displayData].sort((a, b) => {
                let va, vb;
                
                if (key === 'modelId') {
                    va = a.modelId;
                    vb = b.modelId;
                } else if (key === 'modalities') {
                    va = a.modalities.join(', ');
                    vb = b.modalities.join(', ');
                } else {
                    va = a.details[key] || '';
                    vb = b.details[key] || '';
                }
                
                return currentSort.asc
                    ? va.toString().localeCompare(vb.toString())
                    : vb.toString().localeCompare(va.toString());
            });

            renderTable(sorted);
        }

        function filterTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            const apiOnly = document.getElementById('apiFilter').checked;
            let filtered = tableData.filter(item => {
                // Text search
                const modelMatch = item.modelId.toLowerCase().includes(query);
                const detailsMatch = Object.values(item.details)
                    .some(val => val.toString().toLowerCase().includes(query));
                const modalitiesMatch = item.modalities.some(modality => 
                    modality.toLowerCase().includes(query));
                const providerMatch = item.apiIdentifier.toLowerCase().includes(query);
                
                const textMatch = modelMatch || detailsMatch || modalitiesMatch || providerMatch;
                
                // Modality filter
                const modalityMatch = selectedModalities.size === 0 || 
                    item.modalities.some(modality => selectedModalities.has(modality));
                
                // API endpoints only filter - use the improved detection
                const serviceMatch = !apiOnly || isApiEndpoint(item.modelId, item.details, item.modalities);

                return textMatch && modalityMatch && serviceMatch;
            });
            
            renderTable(filtered);
        }

        // Column resize functionality
        function startResize(e, columnKey) {
            e.preventDefault();
            e.stopPropagation();
            
            const handle = e.target;
            const header = handle.parentElement;
            const startX = e.clientX;
            const startWidth = header.offsetWidth;
            
            // Add active class for visual feedback
            handle.classList.add('active');
            document.body.style.cursor = 'col-resize';
            
            function onMouseMove(e) {
                const deltaX = e.clientX - startX;
                const newWidth = Math.max(100, startWidth + deltaX); // Minimum 100px
                
                columnWidths[columnKey] = newWidth + 'px';
                header.style.width = newWidth + 'px';
                
                // Update all cells in this column
                const columnIndex = Array.from(header.parentElement.children).indexOf(header);
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cell = row.children[columnIndex];
                    if (cell) {
                        cell.style.width = newWidth + 'px';
                    }
                });
                
                // Force table to recalculate layout
                const table = header.closest('table');
                if (table) {
                    table.style.width = table.offsetWidth + 'px';
                }
            }
            
            function onMouseUp() {
                handle.classList.remove('active');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                localStorage.setItem('columnWidths', JSON.stringify(columnWidths));
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Column drag functionality
        function startDrag(e, columnKey) {
            e.preventDefault();
            e.stopPropagation();
            
            const handle = e.target;
            isDragging = true;
            draggedColumn = columnKey;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            // Add active class for visual feedback
            handle.classList.add('active');
            document.body.style.cursor = 'grabbing';
            
            function onMouseMove(e) {
                if (!isDragging) return;
                
                const deltaX = Math.abs(e.clientX - dragStartX);
                const deltaY = Math.abs(e.clientY - dragStartY);
                
                // Only start drag if moved horizontally more than vertically
                if (deltaX > deltaY && deltaX > 10) {
                    // Find the target column based on mouse position
                    const headers = document.querySelectorAll('th');
                    let targetColumn = null;
                    
                    headers.forEach((header) => {
                        const rect = header.getBoundingClientRect();
                        if (e.clientX > rect.left && e.clientX < rect.right) {
                            targetColumn = header.textContent.trim();
                        }
                    });
                    
                    if (targetColumn && targetColumn !== draggedColumn) {
                        // Reorder columns
                        const oldIndex = columnOrder.indexOf(draggedColumn);
                        const newIndex = columnOrder.indexOf(targetColumn);
                        
                        if (oldIndex !== -1 && newIndex !== -1) {
                            columnOrder.splice(oldIndex, 1);
                            columnOrder.splice(newIndex, 0, draggedColumn);
                            localStorage.setItem('columnOrder', JSON.stringify(columnOrder));
                            renderTable(displayData);
                        }
                    }
                }
            }
            
            function onMouseUp() {
                isDragging = false;
                draggedColumn = null;
                handle.classList.remove('active');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Column control functions
        function resetColumnWidths() {
            columnWidths = {};
            localStorage.removeItem('columnWidths');
            renderTable(displayData);
        }

        function resetColumnOrder() {
            columnOrder = [...allColumns];
            localStorage.removeItem('columnOrder');
            renderTable(displayData);
        }

        function toggleColumnResize() {
            resizeMode = !resizeMode;
            const btn = document.getElementById('resizeToggle');
            btn.classList.toggle('active', resizeMode);
            btn.textContent = resizeMode ? 'Disable Resize' : 'Enable Resize';
            
            // Add visual indicator to table
            const table = document.querySelector('table');
            if (table) {
                if (resizeMode) {
                    table.style.border = '2px solid #1976d2';
                } else {
                    table.style.border = '';
                }
            }
            
            renderTable(displayData);
        }

        function toggleColumnDrag() {
            dragMode = !dragMode;
            const btn = document.getElementById('dragToggle');
            btn.classList.toggle('active', dragMode);
            btn.textContent = dragMode ? 'Disable Drag' : 'Enable Drag';
            
            // Add visual indicator to table
            const table = document.querySelector('table');
            if (table) {
                if (dragMode) {
                    table.style.border = '2px solid #ff9800';
                } else if (!resizeMode) {
                    table.style.border = '';
                }
            }
            
            renderTable(displayData);
        }

        function showDetails(item) {
            const modal = document.getElementById('detailsModal');
            const body = document.getElementById('modalBody');
            const info = {
                model: item.modelId,
                api_identifier: item.apiIdentifier,
                service_type: item.serviceType,
                modalities: item.modalities,
                source: item.source,
                last_updated: item.lastUpdated,
                api_schema: item.apiSchema,
                raw: item.details,
            };
            body.innerHTML = '';
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(info, null, 2);
            body.appendChild(pre);
            modal.style.display = 'flex';
        }

        document.getElementById('modalClose').onclick = () => {
            document.getElementById('detailsModal').style.display = 'none';
        };
        document.getElementById('serviceListModalClose').onclick = () => {
            document.getElementById('serviceListModal').style.display = 'none';
        };
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('detailsModal');
            const serviceModal = document.getElementById('serviceListModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
            if (event.target === serviceModal) {
                serviceModal.style.display = 'none';
            }
        });

        function showServiceList(serviceType, title) {
            const modal = document.getElementById('serviceListModal');
            const modalTitle = document.getElementById('serviceListTitle');
            const modalBody = document.getElementById('serviceListBody');
            
            modalTitle.textContent = title;
            
            let filteredData;
            if (serviceType === 'all') {
                filteredData = tableData;
            } else {
                filteredData = tableData.filter(item => item.serviceType === serviceType);
            }
            
            const html = filteredData.map(item => `
                <div class="service-list-item">
                    <div class="service-name">${item.modelId}</div>
                    <div class="service-details">
                        <span class="service-provider">${item.apiIdentifier}</span>
                        <span class="service-modalities">${item.modalities.join(', ')}</span>
                    </div>
                </div>
            `).join('');
            
            modalBody.innerHTML = html || '<p>No services found.</p>';
            modal.style.display = 'flex';
        }

        function showProviderList() {
            const modal = document.getElementById('serviceListModal');
            const modalTitle = document.getElementById('serviceListTitle');
            const modalBody = document.getElementById('serviceListBody');
            
            modalTitle.textContent = 'Data Providers';
            
            const providerStats = {};
            tableData.forEach(item => {
                const provider = item.apiIdentifier;
                if (!providerStats[provider]) {
                    providerStats[provider] = [];
                }
                providerStats[provider].push(item);
            });
            
            const html = Object.entries(providerStats).map(([provider, services]) => `
                <div class="service-list-item">
                    <div class="service-name">${provider}</div>
                    <div class="service-details">
                        <span class="service-count">${services.length} services</span>
                        <span class="service-types">${[...new Set(services.map(s => s.serviceType))].join(', ')}</span>
                    </div>
                </div>
            `).join('');
            
            modalBody.innerHTML = html || '<p>No providers found.</p>';
            modal.style.display = 'flex';
        }

        function showModalityList() {
            const modal = document.getElementById('serviceListModal');
            const modalTitle = document.getElementById('serviceListTitle');
            const modalBody = document.getElementById('serviceListBody');
            
            modalTitle.textContent = 'Available Modalities';
            
            const modalityStats = {};
            tableData.forEach(item => {
                item.modalities.forEach(modality => {
                    if (!modalityStats[modality]) {
                        modalityStats[modality] = [];
                    }
                    modalityStats[modality].push(item);
                });
            });
            
            const html = Object.entries(modalityStats).map(([modality, services]) => `
                <div class="service-list-item">
                    <div class="service-name">${modality}</div>
                    <div class="service-details">
                        <span class="service-count">${services.length} services</span>
                        <span class="service-providers">${[...new Set(services.map(s => s.apiIdentifier))].join(', ')}</span>
                    </div>
                </div>
            `).join('');
            
            modalBody.innerHTML = html || '<p>No modalities found.</p>';
            modal.style.display = 'flex';
        }

        // Load pricing data on page load
        loadPricing();
    </script>
</body>
</html>
